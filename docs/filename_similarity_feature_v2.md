# ファイル名類似度検出機能 v2.0

## 概要

ファイル名とファイルサイズの類似度に基づいて、同一または類似していると思われるファイルをグループ化して表示する機能です。
チェックボックスによる選択と一括削除機能を備え、重複ファイルや類似ファイルの整理を効率的に行えます。

## 新機能 (v2.0)

### 1. ファイルサイズの考慮
- **ファイルサイズの類似度計算**: サイズが近いファイルを優先的にグループ化
- **複合類似度スコア**: ファイル名とサイズを組み合わせた類似度計算
- **サイズの重み調整**: 0.0-0.9の範囲でサイズの影響度を調整可能（デフォルト: 0.3）
- **サイズ情報の表示**: 各ファイルのサイズと平均サイズを表示

### 2. チェックボックスによるファイル選択
- **個別選択**: 各ファイルの左にチェックボックスを配置
- **一括選択**: 「すべて選択」「すべて解除」ボタン
- **選択数の表示**: 現在チェックされているファイル数をリアルタイム表示

### 3. 一括削除機能
- **ゴミ箱への移動**: チェックしたファイルをゴミ箱に一括移動
- **安全な削除**: 確認ダイアログで誤操作を防止
- **削除結果の表示**: 成功・失敗したファイル数を表示
- **UIの自動更新**: 削除後、ツリーから自動的に項目を除去

## 機能詳細

### ファイルサイズ類似度の計算

```python
def calculate_size_similarity(size1: int, size2: int) -> float:
    """
    2つのファイルサイズの類似度を計算（0.0-1.0）

    サイズの比率を計算:
    - 1000バイトと1000バイト → 1.0 (完全一致)
    - 1000バイトと900バイト → 0.9 (90%類似)
    - 1000バイトと100バイト → 0.1 (10%類似)
    """
```

### 複合類似度の計算

```python
def calculate_combined_similarity(
    name1: str,
    name2: str,
    size1: int,
    size2: int,
    name_weight: float = 0.7,  # ファイル名の重み
    size_weight: float = 0.3,  # サイズの重み
) -> float:
    """
    ファイル名とサイズを組み合わせた類似度を計算

    例: name_weight=0.7, size_weight=0.3の場合
    - ファイル名類似度: 0.9
    - サイズ類似度: 1.0
    → 総合類似度 = 0.9 × 0.7 + 1.0 × 0.3 = 0.93
    """
```

## 使い方

### 基本的な検索手順

1. **フォルダ選択**
   - ファイルマネージャーで対象フォルダを選択
   - ツールバーの「類似ファイル名」ボタンをクリック

2. **検索設定**
   - **サブフォルダを含める**: オンにするとサブディレクトリも検索
   - **類似度しきい値**: 0.7-0.9が推奨（低いほど広範囲に検出）
   - **最小グループサイズ**: 2以上のファイルでグループ化
   - **ファイルサイズも考慮する**: オン（推奨）でサイズも判定基準に
   - **サイズの重み**: 0.3が推奨（高いほどサイズを重視）

3. **検索実行**
   - 「検索開始」ボタンをクリック
   - 進捗バーで進捗を確認

4. **結果の確認**
   - グループごとに類似ファイルが表示される
   - 各ファイルのサイズと相対パスを確認

5. **ファイルの選択と削除**
   - 削除したいファイルにチェックを入れる
   - 「チェック済みファイルを削除」ボタンをクリック
   - 確認ダイアログで「はい」を選択
   - ファイルがゴミ箱に移動される

### ショートカット機能

- **ダブルクリック**: ファイルを既定のアプリケーションで開く
- **すべて選択**: ツリー内のすべてのファイルをチェック
- **すべて解除**: すべてのチェックを外す
- **結果をエクスポート**: 検索結果をテキストファイルに保存

## 検索結果の表示

```
グループ 1 (3 ファイル)              平均: 1.0 MB    95.00%
  ☑ video_01.mp4                    1.0 MB          video_01.mp4
  ☑ video_02.mp4                    1.0 MB          video_02.mp4
  ☐ video_03.mp4                    1.1 MB          video_03.mp4

グループ 2 (2 ファイル)              平均: 5.5 MB    88.50%
  ☑ movie.mp4                       5.0 MB          movie.mp4
  ☑ movie (copy).mp4                6.0 MB          movie (copy).mp4
```

カラム構成:
- **☑**: チェックボックス（削除対象の選択）
- **ファイル名**: ファイルの名前
- **サイズ**: ファイルサイズ（KB, MB, GB等で表示）
- **類似度**: グループの平均類似度（パーセント表示）
- **相対パス**: 検索フォルダからの相対パス

## 実装ファイル

### コアロジック
- `src/file_manager/filename_similarity.py`
  - `calculate_size_similarity()`: サイズ類似度計算
  - `calculate_combined_similarity()`: 複合類似度計算
  - `find_similar_filenames()`: 類似ファイル検索（サイズ考慮対応）
  - `SimilarFileGroup`: ファイルサイズ情報を含むグループデータ

### UI
- `src/file_manager/filename_similarity_dialog.py`
  - ファイルサイズ設定UI（チェックボックス、重みスピンボックス）
  - チェックボックス付きツリー表示
  - 一括選択・解除機能
  - ゴミ箱への一括削除機能
  - サイズ表示機能

### テスト
- `tests/test_filename_similarity.py` (32テスト)
  - サイズ類似度計算のテスト
  - 複合類似度計算のテスト
  - ファイルサイズ考慮検索のテスト
  - SimilarFileGroupの新機能テスト

- `tests/test_filename_similarity_dialog.py` (12テスト)
  - 新UIコンポーネントのテスト
  - チェックボックス機能のテスト
  - 削除機能のテスト（モック）

## 使用例とベストプラクティス

### ケース1: 連番動画ファイルから品質の低いものを削除

**シナリオ**: 同じ動画の異なる解像度版が混在

設定:
- 類似度しきい値: 0.8
- ファイルサイズも考慮する: オン
- サイズの重み: 0.3

手順:
1. 検索を実行
2. 同じグループ内で最もサイズが小さいファイルにチェック
3. 一括削除で低品質版を削除

### ケース2: バックアップコピーの削除

**シナリオ**: "video (copy).mp4" のようなコピーファイルを削除

設定:
- 類似度しきい値: 0.7
- ファイルサイズも考慮する: オン
- サイズの重み: 0.4（サイズが同じことを重視）

手順:
1. 検索を実行
2. ファイル名に "(copy)" を含むファイルにチェック
3. 一括削除

### ケース3: サイズが大きく異なる同名ファイルの検出

**シナリオ**: 編集前と編集後の動画など、名前は似ているがサイズが異なる

設定:
- 類似度しきい値: 0.6
- ファイルサイズも考慮する: オン
- サイズの重み: 0.5（サイズの違いを重視）

結果:
- サイズが大きく異なるファイルは別グループに分類される
- 編集前/編集後を区別しやすい

## パフォーマンス

### ファイルサイズ取得のオーバーヘッド
- ファイルサイズは`stat()`で取得（高速）
- ファイル内容を読まないため、大きなファイルでも高速

### 検索速度の目安
- 100ファイル: < 1秒
- 500ファイル: 1-3秒
- 1000ファイル: 3-10秒
- 5000ファイル: 15-60秒

### メモリ使用量
- ファイルサイズ情報のみを保持（ファイル内容は読まない）
- 1000ファイルで約1-2MB程度のメモリ使用

## 依存パッケージ

- `send2trash`: ゴミ箱へのファイル移動に使用
  ```bash
  pip install send2trash
  ```

## トラブルシューティング

### Q: ファイルサイズが似ていないのに同じグループになる
A: サイズの重みを増やしてください（例: 0.3 → 0.5）

### Q: ファイルサイズは似ているのに別グループになる
A: 類似度しきい値を下げるか、サイズの重みを増やしてください

### Q: 削除に失敗する
A: 以下を確認してください:
- ファイルが使用中でないか
- ファイルへのアクセス権限があるか
- `send2trash`パッケージがインストールされているか

### Q: 削除後もツリーに残る
A: UIのバグの可能性があります。ダイアログを閉じて再度検索してください

## 既存機能との比較

| 機能 | ファイル名類似度検出 v2.0 | 重複動画検出 |
|------|------------------------|-------------|
| 検出方法 | ファイル名 + サイズ | ファイル内容のハッシュ |
| 速度 | 高速 | 低速 |
| 精度 | 柔軟（調整可能） | 厳密（完全一致） |
| サイズ考慮 | ○ | ○ |
| 一括削除 | ○ | × |
| チェックボックス選択 | ○ | × |
| 用途 | 類似ファイルの整理 | 完全重複の検出 |

## 今後の拡張可能性

- [ ] グループ単位での一括選択
- [ ] 正規表現によるファイル名フィルタリング
- [ ] 作成日時・更新日時の考慮
- [ ] プレビュー機能（サムネイル表示）
- [ ] カスタム削除ルールの保存
- [ ] 削除のUNDO機能
