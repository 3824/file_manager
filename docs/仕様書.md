# GUIファイルマネージャー 仕様書

## 概要
PySide6を使用して開発されたクロスプラットフォーム対応のGUIファイルマネージャーアプリケーションです。WindowsとUnix系OS（Linux/macOS）の両方で動作します。

## 主要機能

### 1. 左ペイン（フォルダナビゲーション）

#### ドライブボタン
- **自動ドライブ検出**: システムに存在するドライブを自動的に検出
  - Windows: A-Zドライブ（存在するもののみ）
  - Unix系: ルートディレクトリ（/）とマウントポイント
- **ボタン配置**: 上部にスクロール可能なドライブボタンを水平配置
- **視覚的フィードバック**: 選択されたドライブボタンがハイライト表示
- **サイズ**: 各ボタンは40x30ピクセルの固定サイズ
- **スクロール**: ドライブ数が多い場合は横スクロールで表示

#### フォルダツリー
- **フォルダーのみ表示**: ファイルは表示せず、フォルダーのみをツリー構造で表示
- **不要な列を非表示**: 「Drive」や更新日時などの列を削除し、フォルダー名のみ表示
- **横幅調整可能**: ユーザーが列幅をリサイズ可能（最小100px、デフォルト200px）
- **横スクロール**: 長いフォルダー名も横スクロールで完全表示
- **展開機能**: ダブルクリックまたはツリーアイコンでフォルダー展開
- **選択連動**: フォルダー選択時に右ペインの内容が自動更新

### 2. 右ペイン（ファイル一覧）

#### 表示モード
- **リスト表示**: ファイル名のみのシンプルなリスト表示
- **アイコン表示**: ファイルをアイコン形式で表示
- **詳細表示**: 名前、サイズ、種類、更新日時、権限、作成日時、属性の列表示

#### 列表示制御
- **右クリックメニュー**: ヘッダー右クリックで表示する列を選択可能
- **動的調整**: 列幅のリサイズとドラッグ&ドロップでの順序変更
- **デフォルト列**: 名前、サイズ、種類、更新日時がデフォルトで表示

#### ソート機能
- **複数ソート基準**: 名前、サイズ、更新日、種類でのソート
- **昇順/降順**: 各列で昇順・降順の切り替え可能

### 3. ツールバー機能

#### ナビゲーション
- **上へボタン**: 親ディレクトリに移動
- **更新ボタン**: 現在のディレクトリを再読み込み

#### 表示制御
- **表示モード切替**: リスト/アイコン/詳細表示の切り替え
- **ソート選択**: ソート基準の選択
- **検索ボックス**: ファイル名によるフィルタリング（リアルタイム）
- **隠しファイル表示**: 隠しファイルの表示/非表示切り替え

#### 設定
- **設定ボタン**: フォント、表示項目、色設定の詳細設定

### 4. ファイル操作

#### 基本操作
- **ダブルクリック**: ファイルをデフォルトアプリケーションで開く
- **フォルダー移動**: フォルダーのダブルクリックでディレクトリ移動

#### コンテキストメニュー（右クリック）
- **ファイル操作**: 開く、コピー、切り取り、貼り付け
- **フォルダー操作**: 名前変更、削除
- **新規作成**: 新規フォルダー作成

#### キーボードショートカット
- **削除確認**: 削除時の確認ダイアログ表示
- **エラーハンドリング**: ファイル操作失敗時の適切なエラーメッセージ

### 5. 設定機能

#### フォント設定
- **左ペイン（フォルダツリー）**: フォントファミリーとサイズの個別設定
- **右ペイン（ファイル一覧）**: フォントファミリーとサイズの個別設定
- **サイズ範囲**: 8-24ptの範囲で設定可能

#### 表示項目設定
- **詳細表示列**: 各列の表示/非表示を個別に制御
- **常時表示**: ファイル名列は常に表示（非表示不可）

#### 色設定
- **ファイル属性別色分け**:
  - 隠しファイル: グレー（#808080）
  - 読み込み専用: 青（#0000FF）
  - システムファイル: 赤（#FF0000）
  - 通常ファイル: 黒（#000000）
- **カスタム色選択**: 各属性の色をカスタマイズ可能

### 6. 技術仕様

#### アーキテクチャ
- **LeftPaneWidget**: ドライブボタンとフォルダツリーを統合した専用ウィジェット
- **FileManagerWidget**: メインのファイルマネージャーウィジェット
- **SettingsDialog**: 設定画面用のダイアログ
- **FileItemDelegate**: ファイル属性に基づく色表示用カスタムデリゲート

#### データモデル
- **QFileSystemModel**: ファイルシステムの情報を管理
- **QSortFilterProxyModel**: ソートとフィルタリング機能を提供
- **分離設計**: 左ペイン用（フォルダーのみ）と右ペイン用（ファイル+フォルダー）のモデルを分離

#### イベント処理
- **シグナル/スロット**: Qtのシグナル/スロット機構による適切なイベント処理
- **ドライブ選択**: ドライブボタンクリック時の自動フォルダツリー更新
- **フォルダ選択**: ツリー内フォルダ選択時の右ペイン更新

#### クロスプラットフォーム対応
- **Windows**: A-Zドライブの自動検出とアクセス
- **Unix系**: ルートディレクトリとマウントポイントの検出
- **ファイル操作**: 各OSに適したファイル操作APIの使用

### 7. UI/UX仕様

#### レイアウト
- **スプリッター**: 左右ペインの比率調整可能（デフォルト: 300:900）
- **フレーム分離**: ドライブエリアとフォルダエリアの視覚的分離
- **レスポンシブ**: ウィンドウリサイズ時の適切なレイアウト調整

#### 視覚的要素
- **フレーム**: 各エリアをStyledPanelフレームで囲み
- **スクロール**: 必要に応じた横スクロールバーの表示
- **アニメーション**: ツリー展開時のアニメーション効果

#### 操作性
- **直感的操作**: ドラッグ&ドロップ、右クリックメニュー
- **キーボード対応**: 基本的なキーボードナビゲーション
- **エラーフィードバック**: 操作失敗時の分かりやすいエラーメッセージ

### 8. 設定保存

#### QSettings使用
- **アプリケーション設定**: FileManager/Settingsキーで設定保存
- **永続化**: アプリケーション終了後も設定を保持
- **デフォルト値**: 各設定項目の適切なデフォルト値を提供

#### 保存項目
- フォント設定（ファミリー、サイズ）
- 表示列設定（各列の表示/非表示）
- 色設定（各属性の色）
- 隠しファイル表示設定

## 開発環境

### 必要なライブラリ
- **PySide6**: Qt6のPythonバインディング
- **Python 3.8+**: 対応Pythonバージョン
- **標準ライブラリ**: os, sys, pathlib等

### ファイル構成
```
src/
├── main.py          # メインエントリーポイント
├── file_manager.py  # ファイルマネージャー本体
requirements.txt     # 依存関係
run.py              # 実行スクリプト
setup.py            # セットアップスクリプト
```

## 今後の拡張予定

### 機能拡張
- ファイル検索機能の強化
- 複数ファイルの一括操作
- ファイルプレビュー機能
- タブ機能（複数フォルダ同時表示）

### パフォーマンス改善
- 大量ファイル表示時の最適化
- 非同期ファイル操作
- キャッシュ機能の実装

### UI改善
- テーマ機能（ダークモード等）
- カスタマイズ可能なツールバー
- より直感的なドラッグ&ドロップ操作

---

## 追加仕様（2025-09 反映）

### 動画ダイジェスト表示

- 概要: 動画ファイル選択時にポップアップでダイジェスト（複数サムネイル）を表示。
- 実装: `video_digest.py`（OpenCV によるフレーム抽出）、`video_digest_dialog.py`（ポップアップ表示）。
- 依存: OpenCV と NumPy は任意。未導入時は `OPENCV_AVAILABLE=False` としエラーメッセージを提示、関連UIは無効化。
- 設定: `QSettings`
  - `video_auto_show_digest` (bool, 既定: False)
  - `thumbnail_count` (int)
  - `thumbnail_width`/`thumbnail_height` (int)

### 同一動画ファイル検出（サイズ一致/ファイル名類似性）

- 概要: 指定フォルダ内の動画ファイルを重複候補としてグルーピングし、比較・選択・ゴミ箱移動を行う。
- 実装: `duplicate_video_detector.py`（ロジック）、`duplicate_video_dialog.py`（UI）。
- 検出タイプ:
  - ファイルサイズ一致
  - ファイル名類似性（`difflib.SequenceMatcher`、しきい値 0.50–1.00、既定 0.80）
- UI:
  - 左: グループ一覧、右: サムネイル比較（各サムネ左上に `QCheckBox`）
  - 「全選択」「全解除」「選択したファイルをゴミ箱に移動」
  - チェック操作直後に選択数および削除ボタンの有効/無効を即時反映
- ゴミ箱: Windows は `winshell`、macOS/Linux は `send2trash` を使用。未導入時は安全なフォールバックを適用。
- スレッド: `DuplicateVideoWorker` によりバックグラウンドで検出。進捗・完了・エラーをシグナルで通知。
- 安定性修正: `QScrollArea` 内 `QLabel` の寿命管理を見直し、削除済みオブジェクトアクセスを回避。

### ファイル検索（インデックス）

- 概要: SQLite によるメタデータインデックスを作成/更新し、キーワード検索を高速化。
- 実装: `file_search.py`（インデックスと検索）、`file_search_dialog.py`（UI）。
- 機能: インデックス作成、更新、キーワード検索、結果ダブルクリックでファイルを開く。

### ディスク使用量分析（円グラフ）

- 概要: ドライブ単位および任意フォルダ内のサイズ分布を円グラフで可視化し、ドリルダウン可能。
- 実装: `disk_analyzer.py`（サイズ集計、その他グループ化）、`disk_analysis_dialog.py`（円グラフ・ドリルダウン UI）。
- 仕様:
  - ドライブ選択コンボ + 分析開始
  - 円グラフ（クリック選択で凡例/リスト連動）、詳細リスト、戻る/フォルダを開く
  - 小項目は「その他」に集約（既定 1MB 未満、変更可能）
- スレッド: `DiskAnalysisWorker` によりバックグラウンド分析。

### UI/UX 変更

- 左ペインのドライブボタンを小型化（30x25、フォント 10px）。
- 同一動画比較画面のヘッダー整理、操作の集約。

### 設定・永続化（QSettings）

- ネームスペース:
  - 動画ダイジェスト: `FileManager/VideoDigest`（実装に準ずる）、`video_auto_show_digest` ほか
  - 同一動画: `FileManager/DuplicateVideo`（`similarity_threshold`、`max_thumbnails`）
  - ディスク分析: `FileManager/DiskAnalysis`

### エラーハンドリング/フォールバック

- OpenCV 未導入: 動画機能を自動的に無効化、ユーザーに案内。
- winshell/send2trash 未導入: OSに応じて代替手段を使用（最終手段として通常削除/移動）。
- 長時間処理: すべてワーカースレッドで実行し、UI フリーズを回避。
