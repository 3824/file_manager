# 要件定義

## 1. 機能概要
PySide6とPython 3.13で実装するスタンドアローン型のクロスプラットフォームファイラー。ウィンドウ上部にドライブショートカットボタン、左ペインにフォルダツリー、右ペインに選択フォルダ内のファイル一覧を表示し、検索、重複動画検出、ディスク使用量可視化、設定保存、動画ダイジェスト生成を単一画面で提供する。SQLiteベースのファイルインデックスで横断検索を高速化し、負荷の高い処理はQThreadワーカーで非同期実行してUIの応答性を保つ。

## 2. ユーザーストーリー
- ポストプロダクションの動画編集者として、散在する素材を一覧し重複動画を見分けたい。これにより不要な素材の削除と整理を迅速に行える。
- プロジェクトフォルダを管理するIT担当者として、ディスク使用量を可視化して容量を逼迫するディレクトリを特定したい。これにより削除やアーカイブ判断を安全に行える。
- ナレッジワーカーとして、複数ドライブにまたがる資料をキーワード検索し、結果から該当フォルダを即座に開きたい。これにより情報収集の切り替え時間を削減できる。
- 複数OSを扱うチームとして、統一されたUIと設定のままツールを配布したい。これにより操作教育コストを抑えつつチーム全体で運用できる。

## 3. 機能要件と受入基準

### 3.1 基本UIとファイル閲覧
- 要件: ドライブショートカット、フォルダツリー、詳細リストを備えた二画面レイアウトでファイル操作を提供する。
- 受入基準:
  - 起動時に接続ドライブごとのボタンが上部に表示され、クリックで対象ドライブに移動できる。
  - 左ペインでフォルダツリーを展開・折り畳みでき、複数フォルダ選択と再描画が即時に行われる。
  - 右ペインでファイル一覧のソート、複数選択、コンテキストメニュー呼び出しが行え、OS標準の操作と整合する。

### 3.2 ファイル検索
- 要件: キーワード検索と範囲指定に対応した高速ファイル検索を提供する。
- 受入基準:
  - 選択フォルダ内検索と全ドライブ横断検索を切り替えられる。
  - 検索結果リストにファイル名・パスが表示され、ダブルクリックで該当フォルダを開ける。
  - SQLiteによるインデックスを~/.file_manager_index.dbに構築し、設定で保存先を変更できる。
  - 検索処理中は進捗表示を行い、UI応答性が維持される。

### 3.3 重複動画検出
- 要件: 指定フォルダ内の動画についてファイル名・内容ベースの重複候補を抽出し、グルーピングして整理操作を支援する。
- 受入基準:
  - バックグラウンドワーカーで解析を行い、処理中も他操作が継続できる。
  - 検出結果は別ウィンドウでグループ表示され、各グループ内で保持・削除対象を選択できる。
  - 削除時はwinshell/send2trashを用いてOSのごみ箱へ移動し、取り消し可能である。
  - OpenCVが未導入の場合は機能を自動的に無効化し、ユーザーに導入手順を案内する。

### 3.4 ディスク使用量グラフ
- 要件: フォルダおよびファイルサイズを円グラフで可視化し、ドリルダウンで詳細を確認できるようにする。
- 受入基準:
  - 指定フォルダの容量割合が円グラフで描画され、クリックしたセグメントの詳細が右ペインに表示される。
  - グラフエリアの範囲選択で対象フォルダまたはファイルのプロパティを表示できる。
  - 容量計測はバックグラウンドで行い、進捗とキャンセル操作を提供する。

### 3.5 設定保存と適用
- 要件: 外観と挙動の設定変更を即時反映し、再起動後も保持する。
- 受入基準:
  - 設定画面でフォント、文字サイズ、アイコンサイズ、リスト配色を変更でき、変更がウィンドウに反映される。
  - 起動時表示を「前回終了時の状態」または「指定フォルダを開く」から選択できる。
  - 設定はQSettingsで永続化され、設定ファイルに秘匿情報を含めない。

### 3.6 動画ダイジェスト生成
- 要件: 選択した動画からダイジェストを生成し、専用ウィンドウで再生できるようにする。
- 受入基準:
  - 動画一覧で動画を選択し「ダイジェスト」ボタンを押すと生成処理が開始される。
  - 生成されたダイジェストは別ウィンドウでプレビューでき、サムネイル数や尺を設定タブから調整できる。
  - 生成処理はOpenCVワーカーで非同期実行され、失敗時は理由と再試行手順を通知する。

## 4. 非機能要件
- パフォーマンス: ファイル検索、重複検出、ダイジェスト生成、容量集計はQThreadベースで非同期実行し、UIメインスレッドをブロックしない。
- クロスプラットフォーム: WindowsとmacOSで同等の機能とショートカットを提供し、パス処理やごみ箱操作を抽象化する。
- データ安全性: 削除操作は常にごみ箱移動を経由し、復元可能である。インデックスDBや設定ファイルはユーザー領域に保存し、権限を最小化する。
- 設定・環境管理: .envでAPIキー等の機密情報を管理し、コードに直書きしない。QT_QPA_PLATFORM=offscreenなどヘッドレス動作用環境変数は自動設定する。
- ビルドと配布: PyInstallerで単一バイナリを生成し、optional dependencyの有無を起動時に判定して案内する。
- 品質保証: 新規機能にはpytest/pytest-qtベースのテストを追加し、flake8・black・isortをコミット前に通過させる。
